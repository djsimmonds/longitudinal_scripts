#!/bin/sh

set -e #stop if any error occurs
set -x #print out progress on the script

## code modified from tbss scripts in FSL, in addition to some custom code
## run on Schwarzenagger

## fsl directory (for fsl scripts)
FSLDIR=/usr/local/fsl

## directory where dti data was processed
subjpath=/Volumes/Governator/DTI_STUDY/subjects
cd $subjpath

## directory where tbss analysis will be carried out
tbsspath=/Volumes/Governator/DTI_STUDY/tbss
mkdir $tbsspath

## which subjects to include in analysis (t1 = time 1 scans, tN = rest scans, tA = all scans (t1 and tN))
t1=$(echo 10124_20060803 10125_20050809 10128_20060706 10129_20070811 10130_20050809 10132_20050816 10133_20071204 10136_20050801 10138_20050908 10145_20050802 10148_20050715 10149_20060523 10150_20050831 10152_20050815 10153_20050815 10156_20051110 10157_20051019 10161_20051111 10162_20050921 10163_20050817 10167_20070630 10169_20051102 10170_20060603 10173_20051128 10174_20060518 10175_20050927 10176_20061106 10177_20051117 10180_20050920 10181_20061216 10183_20070526 10184_20070526 10185_20051004 10186_20051201 10187_20070125 10188_20071017 10189_20060207 10192_20051222 10193_20060204 10194_20060204 10195_20060112 10196_20060114 10197_20060114 10198_20060206 10199_20060113 10200_20060202 10201_20060126 10202_20060123 10204_20060105 10206_20060119 10210_20060216 10211_20060605 10215_20060218 10216_20060218 10217_20060227 10218_20060220 10220_20071121 10221_20060211 10222_20060311 10223_20060615 10226_20051208 10230_20070627 10235_20060325 10241_20060515 10248_20060626 10249_20070127 10252_20060504 10253_20060501 10256_20060408 10257_20070820 10260_20060413 10261_20060417 10263_20060826 10273_20060427 10280_20060513 10281_20060513 10288_20060720 10300_20070705 10301_20080428 10302_20070907 10305_20060608 10311_20060601 10315_20060710 10316_20060622 10318_20061009 10320_20070808 10321_20080401 10329_20060821 10332_20070721 10333_20060729 10335_20060828 10336_20060824 10338_20060831 10339_20060921 10343_20060909 10344_20060909 10345_20060914 10357_20060907 10358_20070111 10359_20061023 10360_20061111 10361_20061111 10363_20070825 10365_20070927 10367_20070306 10368_20071217 10370_20070113 10371_20070308 10374_20070428 10375_20070428 10379_20080422 10385_20061114 10386_20070406 10389_20071106 10391_20070324 10396_20070317 10398_20070317 10400_20070602 10403_20070324 10406_20090611 10408_20070407 10409_20070314 10418_20071117 10421_20070217 10422_20070217 10426_20080206 10428_20070523 10430_20070531 10431_20070605 10434_20070807 10439_20070712 10440_20070706 10441_20070830 10443_20070730 10445_20070817 10450_20070818 10451_20070816 10452_20070809 10454_20071108 10455_20080123 10462_20071006 10463_20070927 10469_20071215 10470_20071015 10472_20071107 10473_20080320 10477_20080215 10479_20071110 10480_20081122 10483_20071215 10485_20071106 10486_20080129 10489_20071112 10492_20071126 10500_20080115 10504_20080119 10507_20080218 10526_20080211 10527_20080628 10529_20080219 10531_20080811 10533_20080818 10534_20080310 10538_20080707 10539_20080222 10542_20080331 10543_20080506 10544_20080719 10545_20080719 10547_20080501 10553_20080521 10563_20080623 10571_20080708 10572_20070521 10580_20080807 10581_20080807 10597_20080812 10599_20080820 10609_20090326 10613_20100225 10620_20090113 10622_20100329 10649_20090413 10657_20090509 10686_20100519 10687_20090714 10688_20090714 10695_20090730 10699_20100522 10703_20100202 10717_20100508 10749_20100223 10760_20100622 10763_20091208 10764_20091208 10785_20100303 10789_20100415 10793_20100310 10797_20100513 10799_20100313 10807_20100503 10815_20100517 10816_20100429 10819_20100610 10825_20100609)
tN=$(echo 10124_20070829 10125_20061021 10125_20070928 10125_20091123 10128_20070808 10128_20080910 10128_20090827 10129_20081007 10129_20090825 10132_20061130 10132_20080104 10132_20081223 10132_20100308 10133_20081217 10133_20100106 10136_20060715 10136_20070721 10136_20080804 10136_20090716 10138_20060717 10138_20070901 10138_20080923 10138_20100213 10148_20060424 10148_20070811 10148_20080819 10148_20090826 10150_20060323 10152_20060701 10152_20080806 10152_20090730 10153_20060701 10153_20070515 10153_20081104 10153_20090728 10156_20060826 10156_20070707 10156_20080703 10156_20090711 10157_20080924 10161_20070719 10161_20081023 10161_20090820 10162_20061220 10162_20071219 10162_20081215 10163_20060731 10163_20070712 10163_20091010 10167_20090512 10169_20060603 10169_20070303 10169_20090613 10173_20061207 10173_20070818 10173_20090121 10173_20090826 10174_20070509 10174_20080828 10174_20090822 10175_20061113 10175_20071203 10175_20081218 10175_20100608 10176_20080818 10176_20090601 10177_20070329 10180_20070113 10181_20080102 10181_20090112 10181_20091212 10183_20080517 10183_20090214 10185_20070426 10186_20071130 10186_20090108 10186_20100310 10187_20080111 10187_20090204 10187_20100105 10188_20090115 10188_20091015 10189_20070607 10192_20070127 10192_20080119 10192_20090314 10192_20100112 10193_20061118 10193_20071208 10193_20090411 10193_20100116 10194_20070124 10194_20071208 10195_20061030 10195_20070714 10201_20061209 10201_20071103 10201_20081213 10201_20091210 10202_20061118 10202_20071218 10202_20090106 10202_20100112 10204_20070110 10206_20070106 10210_20070106 10215_20070720 10215_20080126 10216_20070331 10216_20080201 10217_20100330 10218_20071214 10218_20080628 10220_20081203 10220_20100123 10221_20071129 10221_20081124 10221_20100123 10223_20070330 10223_20080619 10223_20090323 10223_20100402 10226_20070614 10226_20100505 10241_20070303 10241_20080327 10241_20090311 10241_20100405 10248_20070407 10248_20080520 10248_20090318 10248_20100317 10252_20070523 10252_20080626 10252_20090513 10253_20070518 10256_20080625 10256_20090609 10256_20100512 10260_20070707 10263_20070924 10280_20070623 10288_20070321 10288_20080813 10288_20090715 10288_20100518 10300_20080612 10300_20090617 10300_20100616 10311_20070517 10311_20080514 10311_20090420 10315_20070705 10315_20080728 10315_20090604 10316_20070503 10316_20080605 10316_20090514 10316_20100614 10329_20070703 10329_20081112 10329_20090625 10333_20070714 10333_20090917 10333_20100602 10335_20070703 10335_20081013 10335_20090624 10335_20100424 10343_20071018 10343_20081202 10344_20081204 10344_20090908 10358_20070919 10358_20090328 10358_20091207 10359_20070912 10359_20090207 10359_20091217 10360_20070512 10361_20070512 10365_20081108 10365_20091027 10368_20081120 10368_20091124 10370_20071117 10370_20091201 10371_20071025 10374_20071103 10385_20071114 10385_20081217 10385_20091125 10391_20071212 10398_20071024 10408_20080522 10408_20090623 10409_20100420 10451_20081208 10451_20091130 10463_20081108 10470_20081106 10470_20091114 10472_20081117 10472_20091114 10472_20100630 10477_20081118 10477_20100119 10479_20081122 10479_20091031 10480_20091110 10483_20090202 10489_20081209 10489_20100107 10500_20090425 10500_20100508 10527_20090711 10527_20100626 10529_20090325 10529_20100104 10542_20090319)
tA=$(echo 10124_20060803 10124_20070829 10125_20050809 10125_20061021 10125_20070928 10125_20091123 10128_20060706 10128_20070808 10128_20080910 10128_20090827 10129_20070811 10129_20081007 10129_20090825 10130_20050809 10132_20050816 10132_20061130 10132_20080104 10132_20081223 10132_20100308 10133_20071204 10133_20081217 10133_20100106 10136_20050801 10136_20060715 10136_20070721 10136_20080804 10136_20090716 10138_20050908 10138_20060717 10138_20070901 10138_20080923 10138_20100213 10145_20050802 10148_20050715 10148_20060424 10148_20070811 10148_20080819 10148_20090826 10149_20060523 10150_20050831 10150_20060323 10152_20050815 10152_20060701 10152_20080806 10152_20090730 10153_20050815 10153_20060701 10153_20070515 10153_20081104 10153_20090728 10156_20051110 10156_20060826 10156_20070707 10156_20080703 10156_20090711 10157_20051019 10157_20080924 10161_20051111 10161_20070719 10161_20081023 10161_20090820 10162_20050921 10162_20061220 10162_20071219 10162_20081215 10163_20050817 10163_20060731 10163_20070712 10163_20091010 10167_20070630 10167_20090512 10169_20051102 10169_20060603 10169_20070303 10169_20090613 10170_20060603 10173_20051128 10173_20061207 10173_20070818 10173_20090121 10173_20090826 10174_20060518 10174_20070509 10174_20080828 10174_20090822 10175_20050927 10175_20061113 10175_20071203 10175_20081218 10175_20100608 10176_20061106 10176_20080818 10176_20090601 10177_20051117 10177_20070329 10180_20050920 10180_20070113 10181_20061216 10181_20080102 10181_20090112 10181_20091212 10183_20070526 10183_20080517 10183_20090214 10184_20070526 10185_20051004 10185_20070426 10186_20051201 10186_20071130 10186_20090108 10186_20100310 10187_20070125 10187_20080111 10187_20090204 10187_20100105 10188_20071017 10188_20090115 10188_20091015 10189_20060207 10189_20070607 10192_20051222 10192_20070127 10192_20080119 10192_20090314 10192_20100112 10193_20060204 10193_20061118 10193_20071208 10193_20090411 10193_20100116 10194_20060204 10194_20070124 10194_20071208 10195_20060112 10195_20061030 10195_20070714 10196_20060114 10197_20060114 10198_20060206 10199_20060113 10200_20060202 10201_20060126 10201_20061209 10201_20071103 10201_20081213 10201_20091210 10202_20060123 10202_20061118 10202_20071218 10202_20090106 10202_20100112 10204_20060105 10204_20070110 10206_20060119 10206_20070106 10210_20060216 10210_20070106 10211_20060605 10215_20060218 10215_20070720 10215_20080126 10216_20060218 10216_20070331 10216_20080201 10217_20060227 10217_20100330 10218_20060220 10218_20071214 10218_20080628 10220_20071121 10220_20081203 10220_20100123 10221_20060211 10221_20071129 10221_20081124 10221_20100123 10222_20060311 10223_20060615 10223_20070330 10223_20080619 10223_20090323 10223_20100402 10226_20051208 10226_20070614 10226_20100505 10230_20070627 10235_20060325 10241_20060515 10241_20070303 10241_20080327 10241_20090311 10241_20100405 10248_20060626 10248_20070407 10248_20080520 10248_20090318 10248_20100317 10249_20070127 10252_20060504 10252_20070523 10252_20080626 10252_20090513 10253_20060501 10253_20070518 10256_20060408 10256_20080625 10256_20090609 10256_20100512 10257_20070820 10260_20060413 10260_20070707 10261_20060417 10263_20060826 10263_20070924 10273_20060427 10280_20060513 10280_20070623 10281_20060513 10288_20060720 10288_20070321 10288_20080813 10288_20090715 10288_20100518 10300_20070705 10300_20080612 10300_20090617 10300_20100616 10301_20080428 10302_20070907 10305_20060608 10311_20060601 10311_20070517 10311_20080514 10311_20090420 10315_20060710 10315_20070705 10315_20080728 10315_20090604 10316_20060622 10316_20070503 10316_20080605 10316_20090514 10316_20100614 10318_20061009 10320_20070808 10321_20080401 10329_20060821 10329_20070703 10329_20081112 10329_20090625 10332_20070721 10333_20060729 10333_20070714 10333_20090917 10333_20100602 10335_20060828 10335_20070703 10335_20081013 10335_20090624 10335_20100424 10336_20060824 10338_20060831 10339_20060921 10343_20060909 10343_20071018 10343_20081202 10344_20060909 10344_20081204 10344_20090908 10345_20060914 10357_20060907 10358_20070111 10358_20070919 10358_20090328 10358_20091207 10359_20061023 10359_20070912 10359_20090207 10359_20091217 10360_20061111 10360_20070512 10361_20061111 10361_20070512 10363_20070825 10365_20070927 10365_20081108 10365_20091027 10367_20070306 10368_20071217 10368_20081120 10368_20091124 10370_20070113 10370_20071117 10370_20091201 10371_20070308 10371_20071025 10374_20070428 10374_20071103 10375_20070428 10379_20080422 10385_20061114 10385_20071114 10385_20081217 10385_20091125 10386_20070406 10389_20071106 10391_20070324 10391_20071212 10396_20070317 10398_20070317 10398_20071024 10400_20070602 10403_20070324 10406_20090611 10408_20070407 10408_20080522 10408_20090623 10409_20070314 10409_20100420 10418_20071117 10421_20070217 10422_20070217 10426_20080206 10428_20070523 10430_20070531 10431_20070605 10434_20070807 10439_20070712 10440_20070706 10441_20070830 10443_20070730 10445_20070817 10450_20070818 10451_20070816 10451_20081208 10451_20091130 10452_20070809 10454_20071108 10455_20080123 10462_20071006 10463_20070927 10463_20081108 10469_20071215 10470_20071015 10470_20081106 10470_20091114 10472_20071107 10472_20081117 10472_20091114 10472_20100630 10473_20080320 10477_20080215 10477_20081118 10477_20100119 10479_20071110 10479_20081122 10479_20091031 10480_20081122 10480_20091110 10483_20071215 10483_20090202 10485_20071106 10486_20080129 10489_20071112 10489_20081209 10489_20100107 10492_20071126 10500_20080115 10500_20090425 10500_20100508 10504_20080119 10507_20080218 10526_20080211 10527_20080628 10527_20090711 10527_20100626 10529_20080219 10529_20090325 10529_20100104 10531_20080811 10533_20080818 10534_20080310 10538_20080707 10539_20080222 10542_20080331 10542_20090319 10543_20080506 10544_20080719 10545_20080719 10547_20080501 10553_20080521 10563_20080623 10571_20080708 10572_20070521 10580_20080807 10581_20080807 10597_20080812 10599_20080820 10609_20090326 10613_20100225 10620_20090113 10622_20100329 10649_20090413 10657_20090509 10686_20100519 10687_20090714 10688_20090714 10695_20090730 10699_20100522 10703_20100202 10717_20100508 10749_20100223 10760_20100622 10763_20091208 10764_20091208 10785_20100303 10789_20100415 10793_20100310 10797_20100513 10799_20100313 10807_20100503 10815_20100517 10816_20100429 10819_20100610 10825_20100609)

## loops through tA to copy FA files to tbss folder
for t in $tA; do cp $(echo $subjpath/$( echo $t | cut -d "_" -f 1 )/$( echo $t | cut -d "_" -f 2 )/analysis/${t}_FA.nii.gz) $tbsspath/${t}.nii.gz; done

## modification of tbss_1_preproc
cd $tbsspath
mkdir FA
mkdir origdata
for f in $tA; do
	echo processing $f
	# erode a little and zero end slices
	X=`${FSLDIR}/bin/fslval $f dim1`; X=`echo "$X 2 - p" | dc -`
	Y=`${FSLDIR}/bin/fslval $f dim2`; Y=`echo "$Y 2 - p" | dc -`
	Z=`${FSLDIR}/bin/fslval $f dim3`; Z=`echo "$Z 2 - p" | dc -`
	$FSLDIR/bin/fslmaths $f -min 1 -ero -roi 1 $X 1 $Y 1 $Z 0 1 FA/${f}_FA
	# create mask (for use in FLIRT & FNIRT)
	$FSLDIR/bin/fslmaths FA/${f}_FA -bin FA/${f}_FA_mask
	$FSLDIR/bin/immv $f origdata
done
echo "Now running \"slicesdir\" to generate report of all input images"
cd FA
$FSLDIR/bin/slicesdir `$FSLDIR/bin/imglob *_FA.*` > grot 2>&1
cat grot | tail -n 2
/bin/rm grot

## modification of tbss_2_reg
	## 1) fsl_reg of t1 scans (estimates affine (12 dof) transform, then nonlinear transform of t1 scans to template (JHU-DTI81, because this is the atlas, as opposed to the recommended FMRIB58, which is also in MNI space but not aligned with the atlas)
	## 2) estimate rigid (6 dof) transform of within subject scans >1 (tN) to first (t1)
	## 3) combine rigid transformation matrix from 2 and affine transformation from 1 for each tN subject
## move target to FA directory
$FSLDIR/bin/imcp $FSLDIR/data/atlases/JHU/JHU-ICBM-FA-1mm.nii.gz target
f=target
for t in $t1; do
	echo processing $t
  g=${t}_FA
	$FSLDIR/bin/fsl_reg $g $f ${g}_to_$f -e -FA
done
## note, started on 5/6 at 11:39am, can use to get a sense of how long this will take

## copy b0 files from each t1 subject's preprocessing folder for use in rigid transform
mkdir $tbsspath/origdata/b0
cd $tbsspath/origdata/b0
for t in $t1; do
	id=$( echo $t | cut -d "_" -f 1 )
	date=$( echo $t | cut -d "_" -f 2 )
	mkdir $id
	cp $subjpath/$id/$date/preprocessing/${t}_brain.nii.gz $id/${t}.nii.gz
done
## copy b0 files from each tN subject's preprocessing folder, do rigid transform, concatenate with affine transform and copy into FA folder
for t in $tN; do
	id=$( echo $t | cut -d "_" -f 1 )
	date=$( echo $t | cut -d "_" -f 2 )
	cd $id
	t1_=$(ls ${id}*.nii.gz | cut -d "." -f 1 )
	mkdir $date
	cd $date
	cp $subjpath/$id/$date/preprocessing/${t}_brain.nii.gz ${t}.nii.gz
	$FSLDIR/bin/flirt -in ${t} -ref ../$t1_ -omat ${t}.mat -o ${t}_rigid -dof 6
	$FSLDIR/bin/convert_xfm -omat $tbsspath/FA/${t}_FA_to_target.mat -concat $tbsspath/FA/${t1_}_FA_to_target.mat ${t}.mat
	cp $tbsspath/FA/${t1_}_FA_to_target_warp.msf $tbsspath/FA/${t}_FA_to_target_warp.msf 
	$FSLDIR/bin/imcp $tbsspath/FA/${t1_}_FA_to_target_warp.nii.gz $tbsspath/FA/${t}_FA_to_target_warp.nii.gz 
	cd ../..
done

## remainder (tbss_3_postreg, tbss_4_prestats) can be run as is
#cd $tbsspath
#tbss_3_postreg
#tbss_4_prestats
